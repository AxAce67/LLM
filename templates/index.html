<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Factory Engine Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: '#111111',
                        surface: '#ffffff',
                        surfaceBorder: '#eaeaea',
                        accentGray: '#666666',
                    }
                }
            }
        }
    </script>
    <style>
        html,
        body {
            max-width: 100%;
            overflow-x: hidden;
        }

        :root {
            --bg-body: #fafafa;
            --ink-strong: #111111;
            --ink-muted: #666666;
            --accent-main: #111111;
            --panel-border: #eaeaea;
        }

        body {
            background: var(--bg-body);
            color: var(--ink-strong);
            min-height: 100vh;
            color: var(--ink-strong);
        }

        .glass-panel {
            background: #ffffff;
            border: 1px solid var(--panel-border);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.03);
            border-radius: 12px;
            color: var(--ink-strong);
        }

        .gradient-text {
            color: var(--ink-strong);
            font-weight: 700;
        }

        .tab-btn {
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--ink-strong);
            border-bottom: 2px solid var(--ink-strong);
            font-weight: 600;
        }

        .tab-btn:not(.active) {
            color: var(--ink-muted);
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover:not(.active) {
            color: var(--ink-strong);
            border-bottom: 2px solid var(--panel-border);
        }

        .dash-tab-btn {
            border: 1px solid var(--panel-border);
            background: #ffffff;
            color: var(--ink-muted);
            transition: all 0.2s ease;
        }

        .dash-tab-btn:hover {
            background: #fafafa;
            color: var(--ink-strong);
            border-color: #cccccc;
        }

        .dash-tab-btn.active {
            background: var(--ink-strong);
            color: #ffffff;
            border-color: var(--ink-strong);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .help-dot {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            color: var(--ink-muted);
            background: #ffffff;
            border: 1px solid var(--panel-border);
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .help-dot:hover,
        .help-dot:focus {
            color: #ffffff;
            background: var(--ink-strong);
            border-color: var(--ink-strong);
            outline: none;
        }

        .help-tooltip {
            position: relative;
            display: inline-block;
            z-index: 60;
        }

        .help-tooltip .help-body {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            z-index: 999;
            width: min(320px, 78vw);
            margin-top: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--ink-strong);
            background: #ffffff;
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            opacity: 0;
            pointer-events: none;
            transform: translateY(-4px);
            transition: opacity 0.16s ease, transform 0.16s ease;
        }

        .help-tooltip[data-align="left"] .help-body {
            left: 0;
            right: auto;
        }

        .help-tooltip[data-align="center"] .help-body {
            left: 50%;
            right: auto;
            transform: translate(-50%, -4px);
        }

        .help-tooltip[data-vertical="up"] .help-body {
            top: auto;
            bottom: calc(100% + 8px);
        }

        .help-tooltip:hover .help-body,
        .help-tooltip:focus-within .help-body {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .help-tooltip[data-align="center"]:hover .help-body,
        .help-tooltip[data-align="center"]:focus-within .help-body {
            transform: translate(-50%, 0);
        }

        /* ログウィンドウ */
        #log-container::-webkit-scrollbar,
        #chat-history::-webkit-scrollbar {
            width: 6px;
        }

        #log-container::-webkit-scrollbar-track,
        #chat-history::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        #log-container::-webkit-scrollbar-thumb,
        #chat-history::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        .metric-range-select {
            border: 1px solid var(--panel-border);
            background: #ffffff;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            color: var(--ink-strong);
        }

        .metric-range-select:focus {
            outline: none;
            border-color: var(--ink-strong);
            box-shadow: 0 0 0 1px var(--ink-strong);
        }

        .no-wrap-scroll {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            scroll-snap-type: x mandatory;
        }

        .no-wrap-scroll::-webkit-scrollbar {
            display: none;
        }

        .no-wrap-scroll>* {
            flex: 0 0 auto;
            scroll-snap-align: start;
        }

        .status-line {
            font-size: 12px;
            margin-bottom: 8px;
        }

        .status-idle {
            color: #6b7280;
        }

        .status-running {
            color: #b45309;
            font-weight: 600;
        }

        .status-success {
            color: #047857;
            font-weight: 600;
        }

        .status-failed {
            color: #dc2626;
            font-weight: 600;
        }

        .empty-hint {
            color: #6b7280;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            header {
                padding: 14px 14px;
            }

            header nav {
                width: 100%;
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 10px;
            }

            header .text-2xl {
                font-size: 1.25rem;
                line-height: 1.65rem;
            }
        }

        @media (max-width: 768px) {
            main {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }

            .mobile-tight {
                padding: 12px !important;
            }

            .mobile-stack {
                display: block !important;
            }

            .mobile-stack > * + * {
                margin-top: 10px;
            }

            .mobile-table thead {
                display: none;
            }

            .mobile-table,
            .mobile-table tbody,
            .mobile-table tr,
            .mobile-table td {
                display: block;
                width: 100%;
            }

            .mobile-table tbody tr {
                background: #fff;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 10px 12px;
                margin-bottom: 10px;
            }

            .mobile-table tbody td {
                border: none !important;
                padding: 6px 0 !important;
                text-align: left !important;
                font-size: 12px;
                display: flex;
                gap: 8px;
                align-items: baseline;
            }

            .mobile-table tbody td::before {
                content: attr(data-label);
                min-width: 88px;
                color: #6b7280;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: .04em;
                font-size: 10px;
            }

            .mobile-table tbody td[data-label="Control"]::before {
                align-self: center;
            }
        }
    </style>
</head>

<body class="antialiased selection:bg-black selection:text-white pb-12">

    <!-- Header Navigation -->
    <header
        class="sticky top-0 z-50 bg-white/90 backdrop-blur-sm border-b border-gray-200 mb-8 px-4 sm:px-8 py-4 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div class="flex flex-col gap-1 lg:flex-row lg:items-center lg:gap-8 min-w-0 w-full lg:w-auto">
            <div>
                <h1 class="text-2xl font-bold tracking-tight text-black">
                    AI Factory Engine
                </h1>
                <p class="text-xs text-gray-500 mt-1 uppercase tracking-widest font-medium">Operations Console</p>
            </div>

            <!-- Tabs -->
            <nav class="no-wrap-scroll gap-6 text-sm font-medium mt-2 lg:mt-0">
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="tab-btn active pb-1 focus:outline-none transition-colors">
                    Dashboard
                </button>
                <button onclick="switchTab('chat')" id="tab-chat"
                    class="tab-btn pb-1 focus:outline-none transition-colors">
                    AI Chat
                </button>
            </nav>
        </div>

        <div class="no-wrap-scroll items-center gap-3 w-full lg:w-auto mt-2 lg:mt-0">
            <span id="current-role-badge"
                class="text-xs bg-gray-100 text-gray-800 px-3 py-1.5 rounded-md font-semibold tracking-wide whitespace-nowrap">
                Role: Worker
            </span>
            <div id="status-indicator"
                class="flex items-center space-x-2 bg-gray-50 px-3 py-1.5 rounded-md border border-gray-200 whitespace-nowrap">
                <span class="w-2 h-2 rounded-full bg-gray-400" id="status-dot"></span>
                <span id="status-text"
                    class="text-xs font-bold text-gray-600 uppercase tracking-widest">Connecting...</span>
            </div>

            <a id="db-ui-link" href="#" target="_blank" rel="noopener noreferrer"
                class="hidden text-gray-600 hover:text-black font-medium text-sm transition-colors border-l border-gray-200 pl-3 ml-1">
                DB Console
            </a>
            <button id="admin-token-btn" onclick="setAdminToken()"
                class="hidden text-gray-600 hover:text-black font-medium text-sm transition-colors border-l border-gray-200 pl-3">
                Token
            </button>

            <button id="master-toggle-btn" onclick="togglePipeline()"
                class="ml-2 bg-black hover:bg-gray-800 text-white font-semibold py-2 px-5 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-black flex items-center space-x-2 whitespace-nowrap shadow-sm">
                <svg id="master-toggle-icon" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                        clip-rule="evenodd"></path>
                </svg>
                <span id="master-toggle-text" class="text-sm">Ignite All</span>
            </button>

            <div class="help-tooltip ml-1">
                <button type="button" class="help-dot" aria-label="システム起動停止の説明">?</button>
                <div class="help-body">
                    全ノードの収集・学習ループを一括で起動します。<br>
                    停止中でもダッシュボードの閲覧は可能です。
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-3 sm:px-6">

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="space-y-8 animate-fade-in block">
            <section class="mb-8 border-b border-gray-200 pb-4">
                <div class="no-wrap-scroll gap-2">
                    <button id="dash-tab-overview" onclick="switchDashboardSection('overview')"
                        class="dash-tab-btn active text-xs font-semibold px-5 py-2 rounded-lg tracking-wide uppercase transition-all">
                        概要
                    </button>
                    <button id="dash-tab-nodes" onclick="switchDashboardSection('nodes')"
                        class="dash-tab-btn text-xs font-semibold px-5 py-2 rounded-lg tracking-wide uppercase transition-all">
                        ノード運用
                    </button>
                    <button id="dash-tab-training" onclick="switchDashboardSection('training')"
                        class="dash-tab-btn text-xs font-semibold px-5 py-2 rounded-lg tracking-wide uppercase transition-all">
                        学習とデータ
                    </button>
                    <button id="dash-tab-logs" onclick="switchDashboardSection('logs')"
                        class="dash-tab-btn text-xs font-semibold px-5 py-2 rounded-lg tracking-wide uppercase transition-all">
                        ログ監視
                    </button>
                </div>
            </section>

            <div id="dash-section-overview" class="space-y-12">
                <!-- Hero Layout: Top KPIs and Control -->
                <div class="flex flex-col md:flex-row gap-8 items-start justify-between border-b border-gray-200 pb-10">
                    <div class="flex flex-col gap-8 w-full md:w-2/3">
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 tracking-[0.2em] mb-2 uppercase">稼働フェーズ</p>
                            <h2 id="current-phase" class="text-4xl md:text-5xl font-light text-black tracking-tight">
                                Initializing</h2>
                        </div>
                        <div class="flex flex-wrap gap-12">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 tracking-[0.2em] mb-2 uppercase">稼働ワーカー
                                </p>
                                <div class="flex items-baseline space-x-2">
                                    <span id="active-workers"
                                        class="text-4xl md:text-5xl font-light text-black">0</span>
                                    <span class="text-xs text-gray-400 font-medium">ノード</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 tracking-[0.2em] mb-2 uppercase">現在のLoss
                                    (Train)</p>
                                <span id="overview-current-loss"
                                    class="text-4xl md:text-5xl font-light text-black font-mono">0.0000</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Panel -->
                    <div class="w-full md:w-1/3 bg-gray-50 p-6 rounded-2xl border border-gray-100 flex flex-col gap-4">
                        <div>
                            <p class="text-xs font-bold text-black mb-1">システム一括制御</p>
                            <p class="text-[11px] text-gray-500 mb-4 leading-relaxed">全ワーカーノードの収集および学習ループを一括で起動・停止します。
                            </p>
                        </div>
                        <button onclick="togglePipeline()"
                            class="w-full bg-black hover:bg-gray-800 text-white font-medium py-3 px-6 rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-black flex items-center justify-center space-x-3 shadow-md">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-sm tracking-wide">Ignite All</span>
                        </button>

                        <div id="system-alert"
                            class="hidden mt-2 p-3 rounded-lg border border-amber-200 bg-amber-50 text-amber-700 text-[11px] font-medium leading-relaxed">
                        </div>
                    </div>
                </div>

                <!-- Main Charts & Details Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <!-- Main charts (Left 2/3) -->
                    <div class="lg:col-span-2 space-y-10">
                        <div>
                            <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-sm font-bold text-black uppercase tracking-widest">パフォーマンス推移 (CPU / RAM)
                                </h3>
                                <div class="flex items-center gap-3">
                                    <label for="system-range"
                                        class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">期間表示</label>
                                    <select id="system-range"
                                        class="metric-range-select bg-gray-50 hover:bg-gray-100 transition-colors"
                                        onchange="onSystemRangeChange()">
                                        <option value="10s">10秒</option>
                                        <option value="all">全期間</option>
                                        <option value="hour">1時間</option>
                                        <option value="day">1日</option>
                                        <option value="week">1週間</option>
                                        <option value="month">1ヶ月</option>
                                        <option value="year">1年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="h-64 md:h-80 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                                <canvas id="chart-system"></canvas>
                            </div>
                        </div>

                        <div>
                            <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-sm font-bold text-black uppercase tracking-widest">学習損失 (Train / Val)
                                </h3>
                                <div class="flex items-center gap-3">
                                    <label for="training-range"
                                        class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">期間表示</label>
                                    <select id="training-range"
                                        class="metric-range-select bg-gray-50 hover:bg-gray-100 transition-colors"
                                        onchange="onTrainingRangeChange()">
                                        <option value="10s">10秒</option>
                                        <option value="all">全期間</option>
                                        <option value="day">1日</option>
                                        <option value="hour">1時間</option>
                                        <option value="week">1週間</option>
                                        <option value="month">1ヶ月</option>
                                        <option value="year">1年</option>
                                    </select>
                                </div>
                            </div>
                            <div class="h-64 md:h-80 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                                <canvas id="chart-training"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Secondary details (Right 1/3) -->
                    <div class="space-y-8">
                        <!-- Infrastructure Mini Stats -->
                        <div>
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">インフラストラクチャー</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 rounded-xl p-4 flex flex-col justify-between">
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-2">親機 CPU
                                    </p>
                                    <span id="cpu-percent" class="text-2xl font-light text-black font-mono">0%</span>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 flex flex-col justify-between">
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-2">親機 メモリ
                                    </p>
                                    <span id="ram-percent" class="text-2xl font-light text-black font-mono">0%</span>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 flex flex-col justify-between">
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-2">オンライン
                                    </p>
                                    <p id="nodes-online" class="text-2xl font-light text-black">0</p>
                                </div>
                                <div class="bg-gray-50 rounded-xl p-4 flex flex-col justify-between">
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-2">
                                        Worker率</p>
                                    <p id="nodes-worker-ratio" class="text-2xl font-light text-black font-mono">0%</p>
                                </div>
                            </div>
                            <div class="mt-4 bg-gray-50 rounded-xl p-4">
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">自動プロファイル
                                </p>
                                <p id="auto-profile-line" class="text-[11px] text-gray-600 font-medium">Detecting
                                    runtime...</p>
                            </div>
                        </div>

                        <!-- Corpus Distribution -->
                        <div>
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">コーパス構成</h3>
                            <div class="bg-gray-50 rounded-xl p-6 h-64 flex items-center justify-center">
                                <canvas id="chart-corpus"></canvas>
                            </div>
                        </div>

                        <!-- Training Epoch Info -->
                        <div>
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">学習診断詳細</h3>
                            <div class="bg-gray-50 rounded-xl p-5 border-l-4 border-black">
                                <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1">Epoch</p>
                                <p id="overview-current-epoch" class="text-xl font-medium text-black mb-4">0</p>

                                <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1">Val / Best
                                </p>
                                <div class="flex items-baseline gap-2">
                                    <p id="overview-current-val-loss" class="text-lg font-medium text-black font-mono">0.0000</p>
                                    <p id="overview-best-val-loss" class="text-[11px] text-gray-500 font-mono">best: 0.0000</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Connected Nodes Management (NEW) -->
            <div id="dash-section-nodes" class="hidden space-y-8">
                <section class="border-b border-gray-200 pb-6">
                    <h2 class="text-3xl font-light text-black tracking-tight mb-2">ノード運用</h2>
                    <p class="text-sm text-gray-500 font-medium">接続ノードの状態確認と、一括/個別制御を行います。</p>
                </section>

                <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-3 border-b border-gray-200 pb-4 mb-4">
                        <div class="flex flex-col">
                            <h3 class="text-sm font-bold text-black uppercase tracking-widest">接続中ノード一覧</h3>
                            <p class="text-xs text-gray-500 mt-1">ノード単位の制御とテレメトリ</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="controlAllNodes('start', 'worker')"
                                class="text-xs border border-black text-black hover:bg-black hover:text-white transition-colors px-3 py-1.5 rounded-lg font-semibold">
                                全Worker起動
                            </button>
                            <button onclick="controlAllNodes('stop', 'worker')"
                                class="text-xs border border-gray-300 text-black hover:bg-gray-100 transition-colors px-3 py-1.5 rounded-lg font-semibold">
                                全Worker停止
                            </button>
                            <button onclick="fetchNodes()"
                                class="text-xs text-black hover:text-gray-600 font-medium flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                                更新
                            </button>
                            <div class="help-tooltip">
                                <button type="button" class="help-dot" aria-label="ノード一括操作の説明">?</button>
                                <div class="help-body">
                                    全Worker起動/停止は、接続中の worker ノードへ一括制御を送信します。<br>
                                    offline ノードには適用されません。
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm mobile-table">
                            <thead>
                                <tr
                                    class="text-gray-400 uppercase text-[10px] tracking-[0.2em] border-b border-gray-100">
                                    <th class="pb-3 pr-4 font-semibold">Node ID</th>
                                    <th class="pb-3 px-4 font-semibold">Role</th>
                                    <th class="pb-3 px-4 font-semibold">Status</th>
                                    <th class="pb-3 px-4 font-semibold">CPU</th>
                                    <th class="pb-3 px-4 font-semibold">Memory</th>
                                    <th class="pb-3 px-4 font-semibold">Last Seen</th>
                                    <th class="pb-3 pl-4 font-semibold text-right">Control</th>
                                </tr>
                            </thead>
                            <tbody id="nodes-table-body" class="divide-y divide-gray-100">
                                <!-- Nodes will be dynamically injected here -->
                                <tr>
                                    <td colspan="7" class="py-6 text-center text-gray-400">Loading nodes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="dash-section-training" class="hidden space-y-8">
            <section class="border-b border-gray-200 pb-8">
                <h2 class="text-3xl font-light text-black tracking-tight mb-2">学習とデータ管理</h2>
                <p class="text-sm text-gray-500 font-medium">実行ジョブ、品質指標、評価履歴、データ品質をこの画面で管理します。</p>
            </section>

            <section class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                <div class="rounded-xl border border-gray-100 bg-white p-3 shadow-sm">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 mb-1">Epoch</p>
                    <p id="training-quick-epoch" class="text-xl font-semibold text-gray-900">0</p>
                </div>
                <div class="rounded-xl border border-gray-100 bg-white p-3 shadow-sm">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 mb-1">Train</p>
                    <p id="training-quick-loss" class="text-xl font-semibold text-red-500 font-mono">0.0000</p>
                </div>
                <div class="rounded-xl border border-gray-100 bg-white p-3 shadow-sm">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 mb-1">Val</p>
                    <p id="training-quick-val" class="text-xl font-semibold text-gray-900 font-mono">0.0000</p>
                </div>
                <div class="rounded-xl border border-gray-100 bg-white p-3 shadow-sm">
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 mb-1">Best</p>
                    <p id="training-quick-best" class="text-base font-semibold text-gray-700 font-mono">best: 0.0000</p>
                </div>
            </section>

            <section class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                <div class="xl:col-span-2 space-y-6">
                    <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                        <div class="flex flex-wrap justify-between items-center gap-3 border-b border-gray-200 pb-3 mb-4">
                            <h3 class="text-[10px] font-bold text-gray-400 tracking-[0.2em] uppercase">学習・変換ジョブ</h3>
                            <div class="help-tooltip">
                                <button type="button" class="help-dot" aria-label="学習・変換ジョブの説明">?</button>
                                <div class="help-body">
                                    HF LoRA Train: 追加学習ジョブを開始します。<br>
                                    GGUF Export: 学習済みモデルを Ollama / LM Studio 用に変換します。<br>
                                    失敗時は各ステータス行にエラー概要が表示されます。
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div class="rounded-xl border border-gray-100 p-4 bg-gray-50/40">
                                <p class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">HF LoRA Train</p>
                                <input id="hf-base-model" type="text" value="Qwen/Qwen2.5-1.5B-Instruct"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-2"
                                    placeholder="base model">
                                <input id="hf-train-text" type="text" value="dataset/hf/train.txt"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-2"
                                    placeholder="train text">
                                <input id="hf-output-dir" type="text" value="models/hf_lora"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-3"
                                    placeholder="output dir">
                                <button onclick="runHfTrain()"
                                    class="text-xs bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    Run HF Train
                                </button>
                                <p id="hf-train-status-line" class="status-line status-idle mt-2">HF status: idle</p>
                            </div>
                            <div class="rounded-xl border border-gray-100 p-4 bg-gray-50/40">
                                <p class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">GGUF Export</p>
                                <input id="gguf-llama-cpp-dir" type="text" value=""
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-2"
                                    placeholder="llama.cpp path">
                                <input id="gguf-hf-model" type="text" value="Qwen/Qwen2.5-1.5B-Instruct"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-2"
                                    placeholder="HF model">
                                <input id="gguf-out-path" type="text" value="models/export/model.gguf"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-2"
                                    placeholder="output gguf path">
                                <input id="gguf-quant" type="text" value="Q4_K_M"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white mb-3"
                                    placeholder="quant type">
                                <button onclick="runGgufExport()"
                                    class="text-xs bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    Run GGUF Export
                                </button>
                                <p id="gguf-export-status-line" class="status-line status-idle mt-2">GGUF status: idle</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em]">学習診断</h3>
                            <div class="help-tooltip">
                                <button type="button" class="help-dot" aria-label="学習診断の説明">?</button>
                                <div class="help-body">
                                    Epoch: 学習の進行量。<br>
                                    Train Loss: 学習データへの誤差。<br>
                                    Val Loss: 未学習データへの誤差。<br>
                                    基本は「Train/Val が中長期で下がる」状態が良好です。
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                            <div class="rounded-xl bg-gray-50 border border-gray-100 p-3">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Epoch</p>
                                <p id="current-epoch" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                            <div class="rounded-xl bg-gray-50 border border-gray-100 p-3">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Train Loss</p>
                                <p id="current-loss" class="text-2xl font-semibold text-red-500 font-mono">0.0000</p>
                            </div>
                            <div class="rounded-xl bg-gray-50 border border-gray-100 p-3">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Val Loss</p>
                                <p id="current-val-loss" class="text-2xl font-semibold text-black font-mono">0.0000</p>
                            </div>
                            <div class="rounded-xl bg-gray-50 border border-gray-100 p-3">
                                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-1">Best Val</p>
                                <p id="best-val-loss" class="text-base font-semibold text-gray-700 font-mono">best: 0.0000</p>
                            </div>
                        </div>
                        <details class="rounded-lg border border-dashed border-gray-300 bg-white px-3 py-2">
                            <summary class="text-xs font-semibold text-gray-700 cursor-pointer uppercase tracking-wider">Why this matters</summary>
                            <p class="mt-2 text-xs text-gray-500 leading-relaxed">
                                Epoch indicates how far training has progressed. Loss should trend downward over time.
                                Short-term spikes are normal after fresh data ingestion.
                            </p>
                        </details>
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em]">学習診断履歴</p>
                                <span class="text-[10px] text-gray-400">最新20件</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm mobile-table">
                                    <thead>
                                        <tr class="text-gray-400 uppercase text-[10px] tracking-[0.2em] border-b border-gray-100">
                                            <th class="pb-2 pr-4 font-semibold">Time</th>
                                            <th class="pb-2 px-4 font-semibold">Epoch</th>
                                            <th class="pb-2 px-4 font-semibold">Train</th>
                                            <th class="pb-2 px-4 font-semibold">Val</th>
                                            <th class="pb-2 pl-4 font-semibold">Best</th>
                                        </tr>
                                    </thead>
                                    <tbody id="training-history-body" class="divide-y divide-gray-100">
                                        <tr><td colspan="5" class="py-4 text-center empty-hint">No training history yet. 学習開始後に表示されます。</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] mb-4">コーパスストレージ</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span>Wikipedia</span><span id="docs-wiki" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>Web</span><span id="docs-web" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>RSS</span><span id="docs-rss" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>News</span><span id="docs-news" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>arXiv</span><span id="docs-arxiv" class="font-semibold">0</span></div>
                            <div class="flex justify-between"><span>Docs</span><span id="docs-techdocs" class="font-semibold">0</span></div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <p class="text-xs text-gray-500">Blocked by license: <span id="docs-blocked">0</span></p>
                            <p id="dataset-size" class="text-2xl font-bold text-gray-900 mt-1">0.00 MB</p>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                        <div class="flex flex-wrap justify-between items-center gap-2 border-b border-gray-200 pb-3 mb-3">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em]">ソースポリシー編集</h3>
                            <button onclick="fetchPolicies()" class="text-xs text-black hover:text-gray-600 font-medium">更新</button>
                        </div>
                        <div class="space-y-2">
                            <input id="policy-domain" type="text" placeholder="domain (e.g. example.com)" class="w-full border border-gray-200 rounded px-2 py-1 text-xs">
                            <div class="grid grid-cols-2 gap-2">
                                <input id="policy-type" type="text" placeholder="source_type" value="web" class="border border-gray-200 rounded px-2 py-1 text-xs">
                                <input id="policy-license" type="text" placeholder="license_tag" value="unknown" class="border border-gray-200 rounded px-2 py-1 text-xs">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="policy-weight" type="number" step="0.1" value="1.0" class="border border-gray-200 rounded px-2 py-1 text-xs">
                                <label class="text-xs text-gray-700 flex items-center gap-2 px-2 border border-gray-200 rounded">
                                    <input id="policy-allow" type="checkbox" checked>
                                    allow training
                                </label>
                            </div>
                            <input id="policy-notes" type="text" placeholder="notes" class="w-full border border-gray-200 rounded px-2 py-1 text-xs">
                            <div class="flex justify-end">
                                <button onclick="savePolicy()" class="text-xs bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium transition-colors">Save Policy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-3 border-b border-gray-200 pb-3 mb-3">
                        <h3 class="text-sm font-bold text-black uppercase tracking-widest">評価履歴</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="runEvaluation()" class="text-xs bg-black text-white px-3 py-1.5 rounded-lg font-semibold">評価実行</button>
                            <button onclick="fetchEvaluations()" class="text-xs text-black hover:text-gray-600 font-medium">更新</button>
                        </div>
                    </div>
                    <p id="eval-status-line" class="status-line status-idle">Eval status: idle</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm mobile-table">
                            <thead>
                                <tr class="text-gray-400 uppercase text-[10px] tracking-[0.2em] border-b border-gray-100">
                                    <th class="pb-2 pr-4 font-semibold">Time</th>
                                    <th class="pb-2 px-4 font-semibold">Model</th>
                                    <th class="pb-2 px-4 font-semibold">Avg Score</th>
                                    <th class="pb-2 pl-4 font-semibold">Details</th>
                                </tr>
                            </thead>
                            <tbody id="eval-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="4" class="py-4 text-center empty-hint">No evaluation yet. 「評価実行」を押してください。</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-3 border-b border-gray-200 pb-3 mb-3">
                        <h3 class="text-sm font-bold text-black uppercase tracking-widest">モデル履歴</h3>
                        <div class="flex items-center gap-2">
                            <button id="promote-model-btn" onclick="promoteBestModel()" class="text-xs bg-black hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium transition-colors">Bestを本番昇格</button>
                            <button onclick="fetchModels()" class="text-xs text-black hover:text-gray-600 font-medium">更新</button>
                        </div>
                    </div>
                    <p id="model-status-line" class="status-line status-idle">Model status: idle</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm mobile-table">
                            <thead>
                                <tr class="text-gray-400 uppercase text-[10px] tracking-[0.2em] border-b border-gray-100">
                                    <th class="pb-2 pr-4 font-semibold">Time</th>
                                    <th class="pb-2 px-4 font-semibold">Tag</th>
                                    <th class="pb-2 px-4 font-semibold">Score</th>
                                    <th class="pb-2 px-4 font-semibold">Promoted</th>
                                    <th class="pb-2 pl-4 font-semibold">Checkpoint</th>
                                </tr>
                            </thead>
                            <tbody id="model-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="py-4 text-center empty-hint">No model version yet. まず学習と評価を実行してください。</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-3 border-b border-gray-200 pb-3 mb-3">
                        <h3 class="text-sm font-bold text-black uppercase tracking-widest">ソースポリシー一覧</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm mobile-table">
                            <thead>
                                <tr class="text-gray-400 uppercase text-[10px] tracking-[0.2em] border-b border-gray-100">
                                    <th class="pb-2 pr-4 font-semibold">Domain</th>
                                    <th class="pb-2 px-4 font-semibold">Type</th>
                                    <th class="pb-2 px-4 font-semibold">License</th>
                                    <th class="pb-2 px-4 font-semibold">Allow</th>
                                    <th class="pb-2 pl-4 font-semibold">Weight</th>
                                </tr>
                            </thead>
                            <tbody id="policy-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="py-4 text-center empty-hint">No policy yet. 右側のフォームから追加してください。</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                    <div class="flex flex-wrap justify-between items-center gap-3 border-b border-gray-200 pb-3 mb-3">
                        <h3 class="text-sm font-bold text-black uppercase tracking-widest">データセット版履歴</h3>
                        <button onclick="fetchDatasets()" class="text-xs text-black hover:text-gray-600 font-medium">更新</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm mobile-table">
                            <thead>
                                <tr class="text-gray-400 uppercase text-[10px] tracking-[0.2em] border-b border-gray-100">
                                    <th class="pb-2 pr-4 font-semibold">Time</th>
                                    <th class="pb-2 px-4 font-semibold">Tag</th>
                                    <th class="pb-2 px-4 font-semibold">Docs</th>
                                    <th class="pb-2 px-4 font-semibold">Train/Val Tokens</th>
                                    <th class="pb-2 pl-4 font-semibold">Blocked</th>
                                </tr>
                            </thead>
                            <tbody id="dataset-table-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="py-4 text-center text-gray-400">No dataset version yet.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>

        <!-- Read-Only Terminal log -->
        <div id="dash-section-logs" class="hidden">
            <section class="border-b border-gray-200 pb-6 mb-6">
                <h2 class="text-3xl font-light text-black tracking-tight mb-2">ログ監視</h2>
                <p class="text-sm text-gray-500 font-medium">パイプラインの最新ログをフィルタしながら追跡できます。</p>
            </section>
            <div class="bg-white border border-gray-100 rounded-2xl shadow-sm mt-6">
                <!-- Clean Log Header -->
                <div
                    class="px-6 py-4 border-b border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h2 class="text-sm font-bold text-black uppercase tracking-widest">System Logs</h2>
                    <div class="flex items-center gap-4">
                        <input id="log-filter" type="text" placeholder="Filter logs..."
                            class="w-64 border-b border-gray-200 bg-transparent px-1 py-1 text-sm focus:outline-none focus:border-black transition-colors">
                        <label
                            class="text-[10px] text-gray-500 flex items-center gap-2 uppercase tracking-widest cursor-pointer">
                            <input id="log-autoscroll" type="checkbox" checked class="accent-black">
                            Auto-scroll
                        </label>
                    </div>
                </div>
                <div>
                    <div id="log-container"
                        class="font-mono text-[11px] p-6 h-[500px] overflow-y-auto text-gray-600 bg-[#fafafa]">
                        <!-- Logs will be appended here -->
                    </div>
                </div>
            </div>
        </div>

        </div> <!-- End Dashboard View -->

        <!-- CHAT VIEW -->
        <div id="view-chat" class="hidden animate-fade-in flex flex-col items-center max-w-5xl mx-auto w-full">
            <div class="w-full bg-white border border-gray-100 shadow-sm mt-4 min-h-[600px] flex flex-col">
                <div class="bg-white border-b border-gray-100 px-8 py-5 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-black uppercase tracking-widest">
                        AI Assistant
                    </h3>
                    <span class="text-[10px] uppercase font-bold text-gray-400">Self-Regressive</span>
                </div>

                <div class="bg-[#fafafa] p-6 flex-1 flex flex-col">
                    <div class="mb-5 flex flex-wrap items-center justify-between gap-4">
                        <label
                            class="text-[10px] text-gray-400 font-bold uppercase tracking-widest flex items-center gap-2 cursor-pointer">
                            <input id="dev-mode-toggle" type="checkbox" class="accent-black">
                            Dev Chat Mode
                        </label>
                        <div class="flex gap-2">
                            <button onclick="setPromptPreset('summarize')"
                                class="text-[10px] uppercase tracking-widest px-3 py-1.5 border-b border-gray-200 text-gray-500 hover:text-black hover:border-black transition-colors">Summarize</button>
                            <button onclick="setPromptPreset('debug')"
                                class="text-[10px] uppercase tracking-widest px-3 py-1.5 border-b border-gray-200 text-gray-500 hover:text-black hover:border-black transition-colors">Debug</button>
                            <button onclick="setPromptPreset('spec')"
                                class="text-[10px] uppercase tracking-widest px-3 py-1.5 border-b border-gray-200 text-gray-500 hover:text-black hover:border-black transition-colors">Spec</button>
                        </div>
                    </div>

                    <div id="chat-history"
                        class="flex-1 overflow-y-auto mb-4 p-4 bg-white flex flex-col space-y-4 shadow-sm border border-gray-100 relative min-h-[300px]">
                        <!-- Placeholder -->
                        <div id="chat-placeholder"
                            class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-40">
                            <p class="text-sm text-gray-500 italic text-center leading-relaxed">System
                                initialized.<br>Input a prompt to synthesize data.</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center justify-between mb-4 gap-4 px-1">
                        <div class="flex items-center gap-2">
                            <label for="gen-max-tokens"
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Max Tokens</label>
                            <input id="gen-max-tokens" type="number" min="1" max="256" value="120"
                                class="w-20 border-b border-gray-200 bg-transparent px-1 py-1 text-sm text-black focus:outline-none focus:border-black">
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="flex items-center gap-2">
                                <label
                                    class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Temp</label>
                                <input id="gen-temperature" type="number" step="0.1" min="0.1" max="2.0" value="0.8"
                                    class="w-16 border-b border-gray-200 bg-transparent px-1 py-1 text-sm text-black focus:outline-none focus:border-black">
                            </div>
                            <div class="flex items-center gap-2">
                                <label
                                    class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Top-p</label>
                                <input id="gen-top-p" type="number" step="0.05" min="0.1" max="1.0" value="0.95"
                                    class="w-16 border-b border-gray-200 bg-transparent px-1 py-1 text-sm text-black focus:outline-none focus:border-black">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Rep
                                    Pen</label>
                                <input id="gen-repetition-penalty" type="number" step="0.01" min="1.0" max="2.0"
                                    value="1.08"
                                    class="w-16 border-b border-gray-200 bg-transparent px-1 py-1 text-sm text-black focus:outline-none focus:border-black">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white border-t border-gray-100 p-6">
                    <div class="relative flex items-end gap-3 max-w-4xl mx-auto">
                        <textarea id="prompt-input" rows="1" placeholder="Message AI Factory Engine..."
                            class="w-full bg-[#fafafa] text-black border border-gray-100 focus:border-black focus:bg-white px-4 pr-12 py-3 focus:outline-none resize-none overflow-hidden transition-all text-sm"
                            onkeypress="if(event.key === 'Enter') generateText()"></textarea>

                        <button onclick="generateText()"
                            class="absolute right-2 bottom-2 p-2 bg-black text-white hover:bg-gray-800 transition-colors">
                            <svg class="w-4 h-4 transform -rotate-45" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- End Chat View -->

    </main>

    <script>
        let isRunning = false;
        let runtimeConfig = {
            max_generate_tokens: 256,
            db_ui_url: null,
            system_role: "worker",
            postgres_host: "postgres",
            admin_token_required: false,
            use_production_model: true,
            production_checkpoint_exists: false
        };
        let adminToken = localStorage.getItem("admin_api_token") || "";
        let dashboardSection = "overview";
        let systemChart = null;
        let trainingChart = null;
        let corpusChart = null;
        let systemRange = localStorage.getItem("chart_range_system") || "hour";
        let trainingRange = localStorage.getItem("chart_range_training") || "day";

        function adminHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (adminToken) headers['x-admin-token'] = adminToken;
            return headers;
        }

        function setAdminToken() {
            const input = prompt("Enter ADMIN_API_TOKEN (empty to clear):", adminToken || "");
            if (input === null) return;
            adminToken = input.trim();
            if (adminToken) localStorage.setItem("admin_api_token", adminToken);
            else localStorage.removeItem("admin_api_token");
        }

        // ---------- Tab Management ----------
        function switchTab(tabId) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-chat').classList.add('hidden');

            document.getElementById('tab-dashboard').classList.remove('active');
            document.getElementById('tab-chat').classList.remove('active');

            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            if (tabId === 'dashboard') {
                switchDashboardSection(dashboardSection);
                fetchNodes(); // Refresh nodes immediately on switch
            }
        }

        function switchDashboardSection(sectionId) {
            dashboardSection = sectionId;
            const sections = ['overview', 'nodes', 'training', 'logs'];
            sections.forEach((id) => {
                document.getElementById(`dash-section-${id}`).classList.add('hidden');
                document.getElementById(`dash-tab-${id}`).classList.remove('active');
            });
            document.getElementById(`dash-section-${sectionId}`).classList.remove('hidden');
            document.getElementById(`dash-tab-${sectionId}`).classList.add('active');
        }

        function initCharts() {
            if (typeof Chart === 'undefined') return; Chart.defaults.color = '#666666';
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { labels: { boxWidth: 12, usePointStyle: true } }
                },
                scales: {
                    x: { grid: { color: 'rgba(0,0,0,0.04)' } },
                    y: { grid: { color: 'rgba(0,0,0,0.04)' } }
                }
            };

            const systemCtx = document.getElementById('chart-system');
            if (systemCtx) {
                systemChart = new Chart(systemCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'CPU %', data: [], borderColor: '#111111', backgroundColor: 'rgba(0,0,0,0.05)', tension: 0.25 },
                            { label: 'RAM %', data: [], borderColor: '#888888', backgroundColor: 'rgba(0,0,0,0.02)', tension: 0.25 }
                        ]
                    },
                    options: {
                        ...commonOptions,
                        scales: { ...commonOptions.scales, y: { min: 0, max: 100, grid: { color: 'rgba(0,0,0,0.04)' } } }
                    }
                });
            }

            const trainingCtx = document.getElementById('chart-training');
            if (trainingCtx) {
                trainingChart = new Chart(trainingCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Train Loss', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.12)', tension: 0.25 },
                            { label: 'Val Loss', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.12)', tension: 0.25 }
                        ]
                    },
                    options: commonOptions
                });
            }

            const corpusCtx = document.getElementById('chart-corpus');
            if (corpusCtx) {
                corpusChart = new Chart(corpusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Wiki', 'Web', 'RSS', 'News', 'arXiv', 'Docs'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: ['#22c55e', '#0ea5e9', '#14b8a6', '#f59e0b', '#8b5cf6', '#888888']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        }

        function adjustTooltipPosition(tooltip) {
            const body = tooltip.querySelector('.help-body');
            if (!body) return;

            delete tooltip.dataset.align;
            delete tooltip.dataset.vertical;

            const margin = 8;
            let rect = body.getBoundingClientRect();

            // first pass: horizontal
            if (rect.right > window.innerWidth - margin) {
                tooltip.dataset.align = 'left';
                rect = body.getBoundingClientRect();
            }
            if (rect.left < margin) {
                tooltip.dataset.align = 'center';
                rect = body.getBoundingClientRect();
            }

            // vertical flip
            if (rect.bottom > window.innerHeight - margin) {
                tooltip.dataset.vertical = 'up';
            }
        }

        function setupHelpTooltips() {
            document.querySelectorAll('.help-tooltip').forEach((tooltip) => {
                const handler = () => adjustTooltipPosition(tooltip);
                tooltip.addEventListener('mouseenter', handler);
                tooltip.addEventListener('focusin', handler);
            });
            window.addEventListener('resize', () => {
                document.querySelectorAll('.help-tooltip').forEach(adjustTooltipPosition);
            });
        }

        function setStatusLine(elementId, mode, text) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.className = `status-line status-${mode}`;
            el.textContent = text;
        }

        function updateCorpusChartFromStatus(data) {
            if (corpusChart) {
                corpusChart.data.datasets[0].data = [
                    Number(data.stats?.collected_docs_wiki || 0),
                    Number(data.stats?.collected_docs_web || 0),
                    Number(data.stats?.collected_docs_rss || 0),
                    Number(data.stats?.collected_docs_news || 0),
                    Number(data.stats?.collected_docs_arxiv || 0),
                    Number(data.stats?.collected_docs_docs || 0)
                ];
                corpusChart.update();
            }
        }

        function toLocalLabel(ts) {
            const d = new Date(ts);
            if (Number.isNaN(d.getTime())) return "-";
            return d.toLocaleString([], { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }

        function onSystemRangeChange() {
            const el = document.getElementById('system-range');
            systemRange = el?.value || 'hour';
            localStorage.setItem("chart_range_system", systemRange);
            fetchSystemMetrics();
        }

        function onTrainingRangeChange() {
            const el = document.getElementById('training-range');
            trainingRange = el?.value || 'day';
            localStorage.setItem("chart_range_training", trainingRange);
            fetchTrainingMetrics();
        }

        async function fetchSystemMetrics() {
            try {
                const response = await fetch(`/api/metrics/system?range=${encodeURIComponent(systemRange)}`);
                const data = await response.json();
                if (data.status !== "success" || !Array.isArray(data.series)) return;
                if (!systemChart) return;
                systemChart.data.labels = data.series.map(row => toLocalLabel(row.ts));
                systemChart.data.datasets[0].data = data.series.map(row => Number(row.cpu_usage || 0));
                systemChart.data.datasets[1].data = data.series.map(row => Number(row.ram_usage || 0));
                systemChart.update();
            } catch (e) {
                console.error("Failed to fetch system metrics:", e);
            }
        }

        async function fetchTrainingMetrics() {
            try {
                const response = await fetch(`/api/metrics/training?range=${encodeURIComponent(trainingRange)}`);
                const data = await response.json();
                if (data.status !== "success" || !Array.isArray(data.series)) return;
                if (!trainingChart) return;
                trainingChart.data.labels = data.series.map(row => toLocalLabel(row.ts));
                trainingChart.data.datasets[0].data = data.series.map(row => Number(row.train_loss || 0));
                trainingChart.data.datasets[1].data = data.series.map(row => Number(row.val_loss || 0));
                trainingChart.update();

                const tbody = document.getElementById('training-history-body');
                if (tbody) {
                    tbody.innerHTML = '';
                    const recent = [...data.series].slice(-20).reverse();
                    if (recent.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center empty-hint">No training history yet. 学習開始後に表示されます。</td></tr>';
                    } else {
                        recent.forEach(row => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td data-label="Time" class="py-2 pr-4 text-xs text-gray-500">${toLocalLabel(row.ts)}</td>
                                <td data-label="Epoch" class="py-2 px-4 text-xs font-mono text-gray-800">${Number(row.epoch || 0)}</td>
                                <td data-label="Train" class="py-2 px-4 text-xs font-mono text-red-500">${Number(row.train_loss || 0).toFixed(4)}</td>
                                <td data-label="Val" class="py-2 px-4 text-xs font-mono text-gray-800">${Number(row.val_loss || 0).toFixed(4)}</td>
                                <td data-label="Best" class="py-2 pl-4 text-xs font-mono text-gray-700">${Number(row.best_val_loss || 0).toFixed(4)}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                }
            } catch (e) {
                console.error("Failed to fetch training metrics:", e);
            }
        }

        async function fetchRuntimeConfig() {
            try {
                const response = await fetch('/api/runtime-config');
                const data = await response.json();
                runtimeConfig = data;

                const maxTokensInput = document.getElementById('gen-max-tokens');
                const maxTokensHint = document.getElementById('gen-max-tokens-hint');
                maxTokensInput.max = data.max_generate_tokens;
                if (parseInt(maxTokensInput.value, 10) > data.max_generate_tokens) {
                    maxTokensInput.value = data.max_generate_tokens;
                }
                maxTokensHint.textContent = `limit ${data.max_generate_tokens}`;

                const dbUiLink = document.getElementById('db-ui-link');
                if (data.db_ui_url) {
                    dbUiLink.href = data.db_ui_url;
                    dbUiLink.classList.remove('hidden');
                }
                const adminBtn = document.getElementById('admin-token-btn');
                if (data.admin_token_required) {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
                const roleBadge = document.getElementById('current-role-badge');
                roleBadge.textContent = `Role: ${String(data.system_role || 'worker').toUpperCase()}`;
                if ((data.system_role || 'worker') === 'master') {
                    roleBadge.className = "text-xs bg-gray-100 text-gray-800 px-3 py-2 rounded-full border border-gray-200 font-semibold uppercase tracking-wider";
                } else {
                    roleBadge.className = "text-xs bg-white text-slate-700 px-3 py-2 rounded-full border border-gray-200 font-semibold uppercase tracking-wider";
                }

                if (data.auto_profile) {
                    const p = data.auto_profile;
                    document.getElementById('auto-profile-line').textContent =
                        `${String(p.device).toUpperCase()} | ${p.cpu_cores} cores | RAM ${p.available_ram_gb}/${p.total_ram_gb} GB | model=${p.model_size} | gen<=${p.max_generate_tokens}`;
                }
                const modelStatus = document.getElementById('model-status-line');
                if (modelStatus) {
                    const selector = data.use_production_model ? "production" : "latest";
                    const prod = data.production_checkpoint_exists ? "ready" : "missing";
                    modelStatus.textContent = `Model status: selector=${selector}, production_ckpt=${prod}`;
                }
            } catch (e) {
                console.error("Failed to fetch runtime config:", e);
            }
        }

        // ---------- System Overview Polling ----------
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                isRunning = data.is_running;
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                const masterToggleText = document.getElementById('master-toggle-text');
                const masterToggleIcon = document.getElementById('master-toggle-icon');
                const currentPhase = document.getElementById('current-phase');

                if (isRunning) {
                    statusDot.className = "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse";
                    statusText.textContent = "稼働中";
                    statusText.className = "text-sm font-bold text-green-600 uppercase tracking-widest";
                    masterToggleText.textContent = "システム停止";
                    masterToggleIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>`;
                    masterToggleIcon.className = "w-4 h-4 text-red-500";
                    currentPhase.className = "text-2xl font-bold bg-clip-text text-transparent bg-black";
                } else {
                    statusDot.className = "w-2.5 h-2.5 rounded-full bg-gray-400";
                    statusText.textContent = "停止中";
                    statusText.className = "text-sm font-bold text-gray-500 uppercase tracking-widest";
                    masterToggleText.textContent = "システム起動";
                    masterToggleIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>`;
                    masterToggleIcon.className = "w-4 h-4 text-green-600";
                    currentPhase.className = "text-2xl font-bold text-gray-400";
                }

                currentPhase.textContent = data.current_phase;
                document.getElementById('docs-wiki').textContent = data.stats.collected_docs_wiki;
                document.getElementById('docs-web').textContent = data.stats.collected_docs_web;
                document.getElementById('docs-rss').textContent = data.stats.collected_docs_rss || 0;
                document.getElementById('docs-news').textContent = data.stats.collected_docs_news || 0;
                document.getElementById('docs-arxiv').textContent = data.stats.collected_docs_arxiv || 0;
                document.getElementById('docs-techdocs').textContent = data.stats.collected_docs_docs || 0;
                document.getElementById('docs-blocked').textContent = data.stats.blocked_docs || 0;
                document.getElementById('dataset-size').textContent = data.stats.dataset_size_mb + " MB";
                document.getElementById('current-epoch').textContent = data.stats.current_epoch;
                const overviewEpoch = document.getElementById('overview-current-epoch');
                if (overviewEpoch) overviewEpoch.textContent = data.stats.current_epoch;
                const trainingQuickEpoch = document.getElementById('training-quick-epoch');
                if (trainingQuickEpoch) trainingQuickEpoch.textContent = data.stats.current_epoch;
                document.getElementById('current-loss').textContent = data.stats.current_loss.toFixed(4);
                const overviewLoss = document.getElementById('overview-current-loss');
                if (overviewLoss) overviewLoss.textContent = data.stats.current_loss.toFixed(4);
                const trainingQuickLoss = document.getElementById('training-quick-loss');
                if (trainingQuickLoss) trainingQuickLoss.textContent = data.stats.current_loss.toFixed(4);
                document.getElementById('current-val-loss').textContent = (data.stats.current_val_loss || 0).toFixed(4);
                const overviewValLoss = document.getElementById('overview-current-val-loss');
                if (overviewValLoss) overviewValLoss.textContent = (data.stats.current_val_loss || 0).toFixed(4);
                const trainingQuickVal = document.getElementById('training-quick-val');
                if (trainingQuickVal) trainingQuickVal.textContent = (data.stats.current_val_loss || 0).toFixed(4);
                document.getElementById('best-val-loss').textContent = `best: ${(data.stats.best_val_loss || 0).toFixed(4)}`;
                const overviewBestVal = document.getElementById('overview-best-val-loss');
                if (overviewBestVal) overviewBestVal.textContent = `best: ${(data.stats.best_val_loss || 0).toFixed(4)}`;
                const trainingQuickBest = document.getElementById('training-quick-best');
                if (trainingQuickBest) trainingQuickBest.textContent = `best: ${(data.stats.best_val_loss || 0).toFixed(4)}`;

                // 稼働ワーカー推定は /api/nodes 集計結果を優先表示

                const cpuPercentEl = document.getElementById('cpu-percent');
                const ramPercentEl = document.getElementById('ram-percent');
                if (cpuPercentEl) cpuPercentEl.textContent = data.system.cpu_percent.toFixed(1) + "%";
                if (ramPercentEl) ramPercentEl.textContent = data.system.ram_percent.toFixed(1) + "%";
                const cpuBarEl = document.getElementById('cpu-bar');
                const ramBarEl = document.getElementById('ram-bar');
                if (cpuBarEl) cpuBarEl.style.width = data.system.cpu_percent + "%";
                if (ramBarEl) ramBarEl.style.width = data.system.ram_percent + "%";
                updateCorpusChartFromStatus(data);

                const alertBox = document.getElementById('system-alert');
                if (data.system.ram_percent >= 92) {
                    alertBox.textContent = `メモリ使用率が高すぎます (${data.system.ram_percent.toFixed(1)}%)。Worker数削減または推論停止を検討してください。`;
                    alertBox.classList.remove('hidden');
                } else if (data.system.cpu_percent >= 95) {
                    alertBox.textContent = `CPU使用率が非常に高いです (${data.system.cpu_percent.toFixed(1)}%)。処理性能が低下する可能性があります。`;
                    alertBox.classList.remove('hidden');
                } else {
                    alertBox.classList.add('hidden');
                    alertBox.textContent = '';
                }

                // ログの更新
                const logContainer = document.getElementById('log-container');
                const logFilter = (document.getElementById('log-filter').value || '').toLowerCase();
                const autoScroll = document.getElementById('log-autoscroll').checked;
                logContainer.innerHTML = '';
                [...data.logs].reverse().forEach(log => {
                    if (logFilter && !log.toLowerCase().includes(logFilter)) return;
                    const line = document.createElement('div');
                    line.className = "py-0.5 whitespace-pre-wrap break-all";
                    // Colorize basic log patterns
                    let formattedLog = log
                        .replace(/\[Error\]|error/gi, '<span class="text-red-500 font-semibold">$&</span>')
                        .replace(/\[Network\]/g, '<span class="text-black font-semibold">$&</span>')
                        .replace(/Phase changed to:/g, '<span class="text-gray-600 font-semibold">$&</span>');
                    line.innerHTML = formattedLog;
                    logContainer.appendChild(line);
                });
                if (autoScroll) {
                    logContainer.scrollTop = 0;
                }

            } catch (error) {
                console.error("Failed to fetch status:", error);
                document.getElementById('status-text').textContent = "接続エラー";
                document.getElementById('status-dot').className = "w-2.5 h-2.5 rounded-full bg-red-500";
            }
        }

        // ---------- Node Management Polling ----------
        async function fetchNodes() {
            try {
                const response = await fetch('/api/nodes');
                const data = await response.json();

                if (data.status === 'success') {
                    const tbody = document.getElementById('nodes-table-body');
                    tbody.innerHTML = ''; // Clear existing

                    if (data.nodes.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="py-6 text-center empty-hint">No nodes connected. 親機/子機を起動してください。</td></tr>';
                        return;
                    }

                    // 時間計算用（オフライン検知）
                    const nowTS = new Date().getTime();
                    let onlineCount = 0;
                    let runningCount = 0;
                    let offlineCount = 0;
                    let workerCount = 0;
                    let onlineWorkerSlots = 0;

                    data.nodes.forEach(node => {
                        const tr = document.createElement('tr');

                        // Offline判定 (最終報告から120秒以上経過)
                        let lastSeenDate = new Date(node.last_heartbeat);
                        let isOffline = (nowTS - lastSeenDate.getTime()) > 120000;
                        let displayStatus = isOffline ? 'offline' : node.status;
                        if (isOffline) offlineCount += 1; else onlineCount += 1;
                        if (displayStatus === 'running') runningCount += 1;
                        if (node.role === 'worker') workerCount += 1;
                        if (!isOffline) {
                            onlineWorkerSlots += Number(node.active_workers || 0);
                        }

                        // Status Badge Color
                        let statusColor = "bg-white text-gray-500 border-gray-200"; // default/offline
                        if (displayStatus === 'running') statusColor = "bg-green-100 text-green-600 border-green-200";
                        if (displayStatus === 'paused') statusColor = "bg-yellow-100 text-yellow-700 border-yellow-200";

                        const roleBadge = node.role === 'master'
                            ? `<span class="bg-gray-100 text-gray-800 font-semibold px-2 py-0.5 rounded text-[11px] leading-tight uppercase align-middle">Master</span>`
                            : `<span class="bg-white text-slate-600 font-medium px-2 py-0.5 rounded text-[11px] leading-tight uppercase align-middle">Worker</span>`;

                        // UI Row Create
                        tr.innerHTML = `
                            <td data-label="Node ID" class="py-3 pr-4 font-mono text-gray-700 text-xs">...${node.node_id.substring(node.node_id.length - 8)}</td>
                            <td data-label="Role" class="py-3 px-4">${roleBadge}</td>
                            <td data-label="Status" class="py-3 px-4">
                                <span class="px-2 py-1 rounded-md text-xs font-bold uppercase tracking-wider border ${statusColor}">
                                    ${displayStatus}
                                </span>
                            </td>
                            <td data-label="CPU" class="py-3 px-4 font-mono text-xs ${isOffline ? 'text-gray-300' : 'text-gray-800'}">${isOffline ? '--' : node.cpu_usage.toFixed(1) + '%'}</td>
                            <td data-label="Memory" class="py-3 px-4 font-mono text-xs ${isOffline ? 'text-gray-300' : 'text-gray-800'}">${isOffline ? '--' : node.ram_usage.toFixed(1) + '%'}</td>
                            <td data-label="Last Seen" class="py-3 px-4 text-xs text-gray-400" title="${lastSeenDate.toLocaleString()}">${lastSeenDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</td>
                            <td data-label="Control" class="py-3 pl-4 text-right space-x-1">
                                <button onclick="controlNode('${node.node_id}', 'start')" class="p-1.5 rounded-md hover:bg-green-50 text-gray-400 hover:text-green-600 transition disabled:opacity-30 disabled:hover:bg-transparent" title="Start Engine" ${isOffline ? 'disabled' : ''}>
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                                </button>
                                <button onclick="controlNode('${node.node_id}', 'stop')" class="p-1.5 rounded-md hover:bg-red-50 text-gray-400 hover:text-red-500 transition disabled:opacity-30 disabled:hover:bg-transparent" title="Pause Engine" ${isOffline ? 'disabled' : ''}>
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path></svg>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    const totalNodes = data.nodes.length;
                    document.getElementById('nodes-online').textContent = String(onlineCount);
                    document.getElementById('nodes-running').textContent = String(runningCount);
                    document.getElementById('nodes-offline').textContent = String(offlineCount);
                    document.getElementById('nodes-worker-ratio').textContent = totalNodes > 0
                        ? `${Math.round((workerCount / totalNodes) * 100)}%`
                        : '0%';
                    const activeWorkersSpan = document.getElementById('active-workers');
                    if (activeWorkersSpan) {
                        activeWorkersSpan.textContent = String(onlineWorkerSlots);
                    }
                }
            } catch (error) {
                console.error("Failed to fetch nodes:", error);
            }
        }

        async function fetchEvaluations() {
            try {
                const response = await fetch('/api/evals');
                const data = await response.json();
                const tbody = document.getElementById('eval-table-body');
                tbody.innerHTML = '';
                if (data.status !== 'success' || !data.runs || data.runs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center empty-hint">No evaluation yet. 「評価実行」を押してください。</td></tr>';
                    return;
                }
                data.runs.forEach(run => {
                    const tr = document.createElement('tr');
                    const created = new Date(run.created_at);
                    const details = run.result_json?.results?.slice(0, 2)?.map(r => `${r.id}:${(r.score * 100).toFixed(0)}%`).join(", ") || '-';
                    tr.innerHTML = `
                        <td data-label="Time" class="py-2 pr-4 text-xs text-gray-500">${created.toLocaleString()}</td>
                        <td data-label="Model" class="py-2 px-4 text-xs font-semibold text-gray-800">${run.model_tag}</td>
                        <td data-label="Avg Score" class="py-2 px-4 text-xs font-mono text-black font-semibold">${(run.avg_score * 100).toFixed(1)}%</td>
                        <td data-label="Details" class="py-2 pl-4 text-xs text-gray-500">${details}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Failed to fetch evaluations:", error);
            }
        }

        async function fetchEvalStatus() {
            try {
                const response = await fetch('/api/evals/status');
                const data = await response.json();
                if (data.status === 'running') {
                    setStatusLine('eval-status-line', 'running', 'Eval status: running');
                } else if (data.last_error) {
                    setStatusLine('eval-status-line', 'failed', `Eval status: idle (last error: ${data.last_error.slice(0, 80)})`);
                } else {
                    setStatusLine('eval-status-line', 'idle', 'Eval status: idle');
                }
            } catch (error) {
                console.error("Failed to fetch eval status:", error);
            }
        }

        async function runEvaluation() {
            try {
                const response = await fetch('/api/evals/run', { method: 'POST', headers: adminHeaders() });
                const data = await response.json();
                if (!response.ok || data.status === 'error') {
                    setStatusLine('eval-status-line', 'failed', `Eval status: failed (${data.message || `HTTP ${response.status}`})`);
                    return;
                }
                setStatusLine('eval-status-line', 'running', `Eval status: ${data.status} (${data.message || ''})`);
                fetchEvalStatus();
            } catch (error) {
                setStatusLine('eval-status-line', 'failed', 'Eval status: request failed');
                console.error("Failed to run evaluation:", error);
            }
        }

        async function runHfTrain() {
            const body = {
                base_model: document.getElementById('hf-base-model').value.trim(),
                train_text: document.getElementById('hf-train-text').value.trim(),
                output_dir: document.getElementById('hf-output-dir').value.trim(),
            };
            try {
                const response = await fetch('/api/migration/hf-train/run', {
                    method: 'POST',
                    headers: adminHeaders(),
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                setStatusLine('hf-train-status-line', 'running', `HF status: ${data.status} (${data.message || ''})`);
                fetchHfTrainStatus();
            } catch (error) {
                console.error("Failed to run hf train:", error);
            }
        }

        async function fetchHfTrainStatus() {
            try {
                const response = await fetch('/api/migration/hf-train/status');
                const data = await response.json();
                if (data.status === 'running') {
                    setStatusLine('hf-train-status-line', 'running', 'HF status: running');
                } else if (data.last_error) {
                    setStatusLine('hf-train-status-line', 'failed', `HF status: idle (last error: ${String(data.last_error).slice(0, 120)})`);
                } else {
                    setStatusLine('hf-train-status-line', 'idle', 'HF status: idle');
                }
            } catch (error) {
                console.error("Failed to fetch hf train status:", error);
            }
        }

        async function runGgufExport() {
            const body = {
                llama_cpp_dir: document.getElementById('gguf-llama-cpp-dir').value.trim(),
                hf_model: document.getElementById('gguf-hf-model').value.trim(),
                out_gguf: document.getElementById('gguf-out-path').value.trim(),
                quant: document.getElementById('gguf-quant').value.trim(),
            };
            try {
                const response = await fetch('/api/migration/gguf-export/run', {
                    method: 'POST',
                    headers: adminHeaders(),
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                setStatusLine('gguf-export-status-line', 'running', `GGUF status: ${data.status} (${data.message || ''})`);
                fetchGgufExportStatus();
            } catch (error) {
                console.error("Failed to run gguf export:", error);
            }
        }

        async function fetchGgufExportStatus() {
            try {
                const response = await fetch('/api/migration/gguf-export/status');
                const data = await response.json();
                if (data.status === 'running') {
                    setStatusLine('gguf-export-status-line', 'running', 'GGUF status: running');
                } else if (data.last_error) {
                    setStatusLine('gguf-export-status-line', 'failed', `GGUF status: idle (last error: ${String(data.last_error).slice(0, 120)})`);
                } else {
                    setStatusLine('gguf-export-status-line', 'idle', 'GGUF status: idle');
                }
            } catch (error) {
                console.error("Failed to fetch gguf export status:", error);
            }
        }

        async function fetchModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                const tbody = document.getElementById('model-table-body');
                tbody.innerHTML = '';
                if (data.status !== 'success' || !data.models || data.models.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center empty-hint">No model version yet. まず学習と評価を実行してください。</td></tr>';
                    return;
                }
                data.models.forEach(model => {
                    const tr = document.createElement('tr');
                    const created = new Date(model.created_at);
                    const pathTail = (model.checkpoint_path || '-').split('/').slice(-1)[0];
                    tr.innerHTML = `
                        <td data-label="Time" class="py-2 pr-4 text-xs text-gray-500">${created.toLocaleString()}</td>
                        <td data-label="Tag" class="py-2 px-4 text-xs font-semibold text-gray-800">${model.model_tag || '-'}</td>
                        <td data-label="Score" class="py-2 px-4 text-xs font-mono text-black font-semibold">${((model.avg_score || 0) * 100).toFixed(1)}%</td>
                        <td data-label="Promoted" class="py-2 px-4 text-xs ${model.promoted ? 'text-gray-800' : 'text-gray-500'}">${model.promoted ? 'yes' : 'no'}</td>
                        <td data-label="Checkpoint" class="py-2 pl-4 text-xs text-gray-500">${pathTail}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Failed to fetch models:", error);
            }
        }

        async function fetchPolicies() {
            try {
                const response = await fetch('/api/policies');
                const data = await response.json();
                const tbody = document.getElementById('policy-table-body');
                tbody.innerHTML = '';
                if (data.status !== 'success' || !data.policies || data.policies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center empty-hint">No policy yet. 右側のフォームから追加してください。</td></tr>';
                    return;
                }
                data.policies.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="Domain" class="py-2 pr-4 text-xs text-gray-700">${p.domain_pattern}</td>
                        <td data-label="Type" class="py-2 px-4 text-xs text-gray-700">${p.source_type}</td>
                        <td data-label="License" class="py-2 px-4 text-xs text-gray-700">${p.license_tag}</td>
                        <td data-label="Allow" class="py-2 px-4 text-xs ${p.allow_training ? 'text-black font-semibold' : 'text-red-500'}">${p.allow_training ? 'yes' : 'no'}</td>
                        <td data-label="Weight" class="py-2 pl-4 text-xs font-mono text-gray-700">${Number(p.base_weight || 0).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Failed to fetch policies:", error);
            }
        }

        async function savePolicy() {
            const body = {
                domain_pattern: document.getElementById('policy-domain').value.trim(),
                source_type: document.getElementById('policy-type').value.trim() || 'web',
                license_tag: document.getElementById('policy-license').value.trim() || 'unknown',
                allow_training: document.getElementById('policy-allow').checked,
                base_weight: parseFloat(document.getElementById('policy-weight').value || '1.0'),
                notes: document.getElementById('policy-notes').value.trim()
            };
            if (!body.domain_pattern) return;
            try {
                await fetch('/api/policies', {
                    method: 'POST',
                    headers: adminHeaders(),
                    body: JSON.stringify(body)
                });
                fetchPolicies();
            } catch (error) {
                console.error("Failed to save policy:", error);
            }
        }

        async function fetchDatasets() {
            try {
                const response = await fetch('/api/datasets');
                const data = await response.json();
                const tbody = document.getElementById('dataset-table-body');
                tbody.innerHTML = '';
                if (data.status !== 'success' || !data.datasets || data.datasets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center empty-hint">No dataset version yet. パイプライン起動後に表示されます。</td></tr>';
                    return;
                }
                data.datasets.forEach(d => {
                    const created = new Date(d.created_at);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td data-label="Time" class="py-2 pr-4 text-xs text-gray-500">${created.toLocaleString()}</td>
                        <td data-label="Tag" class="py-2 px-4 text-xs text-gray-800 font-semibold">${d.dataset_tag}</td>
                        <td data-label="Docs" class="py-2 px-4 text-xs text-gray-700">${d.total_docs}</td>
                        <td data-label="Train/Val" class="py-2 px-4 text-xs font-mono text-gray-800">${d.train_tokens}/${d.val_tokens}</td>
                        <td data-label="Blocked" class="py-2 pl-4 text-xs text-red-500">${d.blocked_docs}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Failed to fetch datasets:", error);
            }
        }

        async function promoteBestModel() {
            const btn = document.getElementById('promote-model-btn');
            const prevLabel = btn.textContent;
            btn.disabled = true;
            btn.classList.add('opacity-60');
            btn.textContent = 'Promoting...';
            setStatusLine('model-status-line', 'running', 'Model status: promoting ckpt_best -> ckpt_production');
            try {
                const response = await fetch('/api/models/promote', { method: 'POST', headers: adminHeaders() });
                const data = await response.json();
                if (data.status === 'success') {
                    setStatusLine('model-status-line', 'success', `Model status: ${data.message || 'promotion complete'}`);
                    await fetchModels();
                    await fetchRuntimeConfig();
                } else {
                    setStatusLine('model-status-line', 'failed', `Model status: promote failed (${data.message || 'unknown error'})`);
                }
            } catch (error) {
                setStatusLine('model-status-line', 'failed', 'Model status: promote request failed');
                console.error("Failed to promote model:", error);
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-60');
                btn.textContent = prevLabel;
            }
        }

        // ---------- Control Actions ----------
        async function togglePipeline() {
            const action = isRunning ? 'stop' : 'start';
            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: adminHeaders(),
                    body: JSON.stringify({ action: action })
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || data.status === 'error') {
                    if (response.status === 403) {
                        alert("管理トークンが未設定または不一致です。ADMIN_API_TOKENを設定してください。");
                        setAdminToken();
                    } else {
                        alert(`制御に失敗しました: ${data.message || `HTTP ${response.status}`}`);
                    }
                    return;
                }
                fetchStatus();
            } catch (e) {
                console.error("Toggle failed:", e);
                alert("制御リクエストに失敗しました。");
            }
        }

        async function controlNode(nodeId, action) {
            try {
                const response = await fetch(`/api/nodes/${nodeId}/control`, {
                    method: 'POST',
                    headers: adminHeaders(),
                    body: JSON.stringify({ action: action })
                });
                const res = await response.json();
                console.log(res.message);
                // Immediately refresh table to feel responsive
                setTimeout(fetchNodes, 500);
            } catch (e) {
                console.error("Control failed:", e);
            }
        }

        async function controlAllNodes(action, role) {
            if (action === 'stop' && !confirm(`Send STOP to all ${role} nodes?`)) return;
            try {
                await fetch('/api/nodes/control-all', {
                    method: 'POST',
                    headers: adminHeaders(),
                    body: JSON.stringify({ action, role })
                });
                fetchNodes();
            } catch (e) {
                console.error("Bulk control failed:", e);
            }
        }

        function setPromptPreset(mode) {
            const inputEl = document.getElementById('prompt-input');
            if (mode === 'summarize') inputEl.value = "以下の内容を簡潔に要約してください: ";
            if (mode === 'debug') inputEl.value = "次のエラー原因と修正案を提示して: ";
            if (mode === 'spec') inputEl.value = "次の要件の実装仕様を箇条書きで作成して: ";
            inputEl.focus();
        }

        // ---------- Inference Chat ----------
        async function generateText() {
            const inputEl = document.getElementById('prompt-input');
            const prompt = inputEl.value.trim();
            if (!prompt) return;
            const devMode = document.getElementById('dev-mode-toggle').checked;
            const temperature = Math.min(2.0, Math.max(0.1, parseFloat(document.getElementById('gen-temperature').value || "0.8")));
            const topP = Math.min(1.0, Math.max(0.1, parseFloat(document.getElementById('gen-top-p').value || "0.95")));
            const repetitionPenalty = Math.min(2.0, Math.max(1.0, parseFloat(document.getElementById('gen-repetition-penalty').value || "1.08")));
            const maxTokensEl = document.getElementById('gen-max-tokens');
            const configuredMax = runtimeConfig.max_generate_tokens || 256;
            const requestedTokens = Math.min(
                configuredMax,
                Math.max(1, parseInt(maxTokensEl.value || "120", 10))
            );
            maxTokensEl.value = requestedTokens;

            document.getElementById('chat-placeholder').style.display = 'none';
            const chatHistory = document.getElementById('chat-history');

            // Append User Question
            const userDiv = document.createElement('div');
            userDiv.className = 'w-[85%] self-end bg-black text-white p-4 rounded-tl-xl rounded-tr-sm rounded-bl-xl rounded-br-xl shadow-none text-sm';
            userDiv.textContent = devMode ? `[DEV] ${prompt}` : prompt;
            chatHistory.appendChild(userDiv);

            inputEl.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Optional Loading Bubbles
            const aiDiv = document.createElement('div');
            aiDiv.className = 'w-[85%] self-start bg-white border border-gray-200 text-gray-900 p-4 rounded-tl-sm rounded-tr-xl rounded-bl-xl rounded-br-xl shadow-none text-sm';
            aiDiv.innerHTML = '<span class="text-gray-400 italic">Thinking...</span>';
            chatHistory.appendChild(aiDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        max_tokens: requestedTokens,
                        temperature: temperature,
                        top_p: topP,
                        repetition_penalty: repetitionPenalty,
                        rag: true
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    aiDiv.innerHTML = '<span class="font-bold text-black mb-1 block">Agent Response:</span>' + data.text.replace(/\n/g, '<br>');
                } else {
                    aiDiv.innerHTML = `<span class="text-red-500 font-bold">Error:</span> ${data.message}`;
                }
            } catch (err) {
                aiDiv.innerHTML = `<span class="text-red-500 font-bold">Error:</span> Failed to connect to inference server.`;
            }
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // ---------- Setup & Loops ----------
        setInterval(fetchStatus, 2000);
        setInterval(fetchNodes, 5000); // Node table needs less frequent updates
        setInterval(fetchEvaluations, 15000);
        setInterval(fetchEvalStatus, 5000);
        setInterval(fetchModels, 15000);
        setInterval(fetchPolicies, 20000);
        setInterval(fetchDatasets, 20000);
        setInterval(fetchHfTrainStatus, 5000);
        setInterval(fetchGgufExportStatus, 5000);
        setInterval(fetchSystemMetrics, 10000);
        setInterval(fetchTrainingMetrics, 15000);

        // Initial Fetch
        switchDashboardSection('overview');
        const systemRangeEl = document.getElementById('system-range');
        const trainingRangeEl = document.getElementById('training-range');
        if (systemRangeEl) systemRangeEl.value = systemRange;
        if (trainingRangeEl) trainingRangeEl.value = trainingRange;
        initCharts();
        setupHelpTooltips();
        fetchRuntimeConfig();
        fetchStatus();
        fetchNodes();
        fetchSystemMetrics();
        fetchTrainingMetrics();
        fetchEvaluations();
        fetchEvalStatus();
        fetchModels();
        fetchPolicies();
        fetchDatasets();
        fetchHfTrainStatus();
        fetchGgufExportStatus();
    </script>
</body>

</html>
